#!/bin/bash

# Pre-commit hook for password generator
# This hook runs before each commit to ensure code quality

set -e

echo "ğŸ” Running pre-commit checks..."

# Check if Go is installed
if ! command -v go &> /dev/null; then
    echo "âŒ Go is not installed"
    exit 1
fi

# Format code
echo "ğŸ“ Formatting Go code..."
if ! go fmt ./...; then
    echo "âŒ go fmt failed"
    exit 1
fi

# Check for any formatting changes
if [[ -n $(git diff --name-only) ]]; then
    echo "âš ï¸  Code was reformatted. Please add the changes and commit again."
    git diff --name-only
    exit 1
fi

# Vet code
echo "ğŸ” Running go vet..."
if ! go vet ./...; then
    echo "âŒ go vet failed"
    exit 1
fi

# Run tests
echo "ğŸ§ª Running tests..."
if ! go test -race -short ./...; then
    echo "âŒ Tests failed"
    exit 1
fi

# Check for security vulnerabilities (if govulncheck is available)
if command -v govulncheck &> /dev/null; then
    echo "ğŸ”’ Checking for security vulnerabilities..."
    if ! govulncheck ./...; then
        echo "âŒ Security vulnerabilities found"
        exit 1
    fi
fi

# Check for common Go issues with staticcheck (if available)
if command -v staticcheck &> /dev/null; then
    echo "ğŸ” Running staticcheck..."
    if ! staticcheck ./...; then
        echo "âŒ staticcheck failed"
        exit 1
    fi
fi

# Verify module dependencies
echo "ğŸ“¦ Verifying module dependencies..."
if ! go mod verify; then
    echo "âŒ Module verification failed"
    exit 1
fi

# Ensure go.mod and go.sum are tidy
echo "ğŸ§¹ Checking if go.mod is tidy..."
go mod tidy
if [[ -n $(git diff go.mod go.sum) ]]; then
    echo "âš ï¸  go.mod or go.sum is not tidy. Please run 'go mod tidy' and commit the changes."
    git diff go.mod go.sum
    exit 1
fi

# Build the project to ensure it compiles
echo "ğŸ”¨ Building project..."
if ! go build -o /tmp/pwgen-test .; then
    echo "âŒ Build failed"
    exit 1
fi
rm -f /tmp/pwgen-test

echo "âœ… All pre-commit checks passed!"